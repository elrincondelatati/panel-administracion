<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Administrador de Productos</title>

<style>
    body {
        font-family: "Poppins", sans-serif;
        background: #faece2;
        margin: 0;
        padding: 0;
    }

    h1 {
        text-align: center;
        font-size: 36px;
        color: #8b2c1f;
        margin-top: 40px;
    }

    .btn-agregar {
        display: flex;
        justify-content: center;
        margin-top: 25px;
    }

    .btn-agregar button {
        background: #2386d9;
        color: white;
        border: none;
        padding: 14px 25px;
        border-radius: 10px;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .producto-card {
        background: white;
        width: 350px;
        border-radius: 22px;
        padding: 20px;
        margin: 22px auto;
        border: 3px solid #f4b77b;
    }

    .producto-img {
        width: 100%;
        height: 330px;
        object-fit: cover;
        border-radius: 15px;
        background: #fff6f0;
    }

    .producto-nombre {
        font-size: 20px;
        font-weight: bold;
        margin-top: 15px;
    }

    .producto-precio {
        font-size: 22px;
        color: #b01818;
        font-weight: bold;
    }

    .btn-editar, .btn-eliminar {
        padding: 10px 20px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        margin-right: 10px;
        margin-top: 12px;
    }

    .btn-editar { background: #ffb734; color: #000; }
    .btn-eliminar { background: #cf2a2a; color: white; }

    /* Modal */
    #modal {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        justify-content: center;
        align-items: center;
    }

    #modal-contenido {
        background: white;
        width: 90%;
        max-width: 450px;
        padding: 25px;
        border-radius: 16px;
    }

    label {
        font-weight: bold;
        margin-top: 10px;
        display: block;
    }

    input, textarea, select {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border-radius: 10px;
        border: 1px solid #aaa;
    }

    .preview-img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 12px;
        background: #fbf3eb;
    }

    .checkbox-linea {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
    }

    .estado-texto {
        font-size: 14px;
        color: #555;
        font-style: italic;
        display: block;
        margin-left: 32px;
    }
</style>
</head>

<body>

<h1>Administrador de Productos</h1>

<div class="btn-agregar">
    <button onclick="abrirModalNuevo()">‚ûï Agregar Producto</button>
</div>

<div id="lista-productos"></div>

<!-- MODAL -->
<div id="modal">
    <div id="modal-contenido">
        <h2 id="titulo-modal">Nuevo Producto</h2>

        <label>Nombre:</label>
        <input type="text" id="nombre">

        <label>Precio:</label>
        <input type="number" id="precio">

        <label>Descripci√≥n:</label>
        <textarea id="descripcion"></textarea>

        <label>Categor√≠a:</label>
        <select id="categoria">
            <option value="navidad">üéÑ Navidad</option>
            <option value="tejido">üß∂ Tejido</option>
            <option value="hogar">üè† Hogar</option>
            <option value="ninos">üë∂ Ni√±os</option>
            <option value="mujer">üëó Mujer</option>
        </select>

        <br><br>

        <label>Estado del producto:</label>

        <div class="checkbox-linea">
            <input type="checkbox" id="agotado" onchange="marcarAgotado()">
            <span>Producto agotado</span>
        </div>
        <span id="textoAgotado" class="estado-texto"></span>

        <div class="checkbox-linea">
            <input type="checkbox" id="liquidacion" onchange="marcarLiquidacion()">
            <span>Producto en liquidaci√≥n</span>
        </div>
        <span id="textoLiquidacion" class="estado-texto"></span>

        <br><br>

        <label>Imagen:</label>
        <input type="file" id="imagen" accept="image/*" onchange="mostrarPreview()">
        <img id="preview" class="preview-img">

        <br><br>

        <button class="btn-editar" onclick="guardarProducto()">Guardar</button>
        <button class="btn-eliminar" onclick="cerrarModal()">Cerrar</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseUrl = "https://wazkoegfeuttutfoqfjt.supabase.co";
const supabaseKey = "TU_PUBLIC_KEY_AQUI";
const supabase = createClient(supabaseUrl, supabaseKey);

let editandoID = null;

async function cargarProductos() {
    const { data } = await supabase.from("productos").select("*").order("id", { ascending: false });

    const lista = document.getElementById("lista-productos");
    lista.innerHTML = "";

    data.forEach(prod => {
        const card = document.createElement("div");
        card.className = "producto-card";

        let estado = "";
        if (prod.agotado) estado = "<p style='color:red;font-weight:bold'>Producto agotado</p>";
        if (prod.liquidacion) estado = "<p style='color:#b06f00;font-weight:bold;background:yellow;padding:5px;border-radius:8px;'>Producto en liquidaci√≥n</p>";

        card.innerHTML = `
            <img src="${prod.imagen_url}" class="producto-img">
            <div class="producto-nombre">${prod.nombre}</div>
            <div class="producto-precio">$${prod.precio} CLP</div>
            <p>${prod.descripcion}</p>

            ${estado}

            <button class="btn-editar" onclick='editarProducto(${JSON.stringify(prod)})'>Editar</button>
            <button class="btn-eliminar" onclick='eliminarProducto(${prod.id})'>Eliminar</button>
        `;

        lista.appendChild(card);
    });
}

cargarProductos();

function abrirModalNuevo() {
    editandoID = null;

    document.getElementById("titulo-modal").innerText = "Nuevo Producto";

    document.getElementById("nombre").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("descripcion").value = "";
    document.getElementById("categoria").value = "navidad";
    document.getElementById("agotado").checked = false;
    document.getElementById("liquidacion").checked = false;
    document.getElementById("textoAgotado").innerText = "";
    document.getElementById("textoLiquidacion").innerText = "";
    document.getElementById("preview").src = "";

    document.getElementById("modal").style.display = "flex";
}

function cerrarModal() {
    document.getElementById("modal").style.display = "none";
}

function marcarAgotado() {
    if (document.getElementById("agotado").checked) {
        document.getElementById("liquidacion").checked = false;
        document.getElementById("textoAgotado").innerText = "Marcado como agotado";
        document.getElementById("textoLiquidacion").innerText = "";
    } else {
        document.getElementById("textoAgotado").innerText = "";
    }
}

function marcarLiquidacion() {
    if (document.getElementById("liquidacion").checked) {
        document.getElementById("agotado").checked = false;
        document.getElementById("textoLiquidacion").innerText = "Marcado como liquidaci√≥n";
        document.getElementById("textoAgotado").innerText = "";
    } else {
        document.getElementById("textoLiquidacion").innerText = "";
    }
}

function mostrarPreview() {
    const file = document.getElementById("imagen").files[0];
    if (file) {
        document.getElementById("preview").src = URL.createObjectURL(file);
    }
}

async function guardarProducto() {
    const nombre = document.getElementById("nombre").value;
    const precio = document.getElementById("precio").value;
    const descripcion = document.getElementById("descripcion").value;
    const categoria = document.getElementById("categoria").value;
    const agotado = document.getElementById("agotado").checked;
    const liquidacion = document.getElementById("liquidacion").checked;

    let urlImagen = null;

    const file = document.getElementById("imagen").files[0];

    if (file) {
        const nombreArchivo = Date.now() + "_" + file.name;

        const { error: err1 } = await supabase.storage
            .from("productos")
            .upload(nombreArchivo, file);

        if (!err1) {
            urlImagen = `${supabaseUrl}/storage/v1/object/public/productos/${nombreArchivo}`;
        }
    }

    if (editandoID) {
        await supabase.from("productos").update({
            nombre, precio, descripcion, categoria,
            agotado, liquidacion,
            ...(urlImagen && { imagen_url: urlImagen })
        }).eq("id", editandoID);
    } else {
        await supabase.from("productos").insert({
            nombre, precio, descripcion, categoria,
            agotado, liquidacion,
            imagen_url: urlImagen
        });
    }

    cerrarModal();
    cargarProductos();
}

function editarProducto(prod) {
    editandoID = prod.id;

    document.getElementById("titulo-modal").innerText = "Editar Producto";

    document.getElementById("nombre").value = prod.nombre;
    document.getElementById("precio").value = prod.precio;
    document.getElementById("descripcion").value = prod.descripcion;
    document.getElementById("categoria").value = prod.categoria;

    document.getElementById("agotado").checked = prod.agotado;
    document.getElementById("liquidacion").checked = prod.liquidacion;

    document.getElementById("textoAgotado").innerText = prod.agotado ? "Marcado como agotado" : "";
    document.getElementById("textoLiquidacion").innerText = prod.liquidacion ? "Marcado como liquidaci√≥n" : "";

    document.getElementById("preview").src = prod.imagen_url;

    document.getElementById("modal").style.display = "flex";
}

async function eliminarProducto(id) {
    if (confirm("¬øEliminar producto?")) {
        await supabase.from("productos").delete().eq("id", id);
        cargarProductos();
    }
}
</script>

</body>
</html>
