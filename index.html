<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administrador de Productos</title>

    <style>
        body {
            background-color: #fdeee7;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            color: #a33625;
            margin-top: 30px;
            font-size: 2.5rem;
        }

        .btn-agregar {
            display: block;
            margin: 20px auto;
            padding: 15px 25px;
            background-color: #228be6;
            color: white;
            font-size: 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
        }

        .contenedor-productos {
            max-width: 1200px;
            margin: auto;
            padding: 20px;
        }

        .producto-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
            border: 2px solid #f5d1b5;
        }

        .producto-card img {
            width: 160px;
            height: 160px;
            object-fit: cover;
            border-radius: 15px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            font-size: 13px;
            border-radius: 12px;
            margin-bottom: 5px;
        }

        .agotado {
            background: red;
            color: white;
        }

        .liquidacion {
            background: gold;
            color: red;
            font-weight: bold;
        }

        /* Modal */
        #modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        #modal-contenido {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
        }

        label {
            font-weight: bold;
            color: #6a1b1a;
        }

        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 6px 0 15px;
            border-radius: 8px;
            border: 1px solid #aaa;
        }

        .opciones-estado {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .estado-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .estado-msg {
            margin-top: -10px;
            font-size: 14px;
            font-weight: bold;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-guardar { background: green; color: white; }
        .btn-cerrar { background: #a32c2c; color: white; margin-left: 10px; }
        .btn-editar { background: orange; }
        .btn-eliminar { background: red; color: white; }
    </style>
</head>
<body>

    <h1>Administrador de Productos</h1>
    <button class="btn-agregar" onclick="abrirModal()">‚ûï Agregar Producto</button>

    <div class="contenedor-productos" id="lista-productos"></div>

    <!-- MODAL -->
    <div id="modal">
        <div id="modal-contenido">

            <h2 id="titulo-modal">Nuevo Producto</h2>

            <label>Nombre:</label>
            <input type="text" id="nombre">

            <label>Precio:</label>
            <input type="number" id="precio">

            <label>Descripci√≥n:</label>
            <textarea id="descripcion"></textarea>

            <label>Categor√≠a:</label>
            <select id="categoria">
                <option value="navidad">Navidad üéÑ</option>
                <option value="tejido">Tejido üßµ</option>
                <option value="hogar">Hogar üè°</option>
                <option value="ni√±os">Ni√±os üë∂</option>
                <option value="mujer">Mujer üëó</option>
            </select>

            <label>Estado del producto:</label>
            <div class="opciones-estado">
                <div class="estado-item">
                    <input type="radio" name="estado" id="estado-normal" checked>
                    <span>Disponible</span>
                </div>
                <div class="estado-item">
                    <input type="radio" name="estado" id="estado-agotado">
                    <span>Agotado</span>
                </div>
                <div class="estado-item">
                    <input type="radio" name="estado" id="estado-liquidacion">
                    <span>Liquidaci√≥n</span>
                </div>
            </div>

            <div id="estado-msg" class="estado-msg"></div>

            <label>Imagen:</label>
            <input type="file" id="imagen" accept="image/*">
            <img id="preview" style="width:100%; border-radius:10px; display:none;">

            <br><br>
            <button class="btn btn-guardar" onclick="guardarProducto()">Guardar</button>
            <button class="btn btn-cerrar" onclick="cerrarModal()">Cerrar</button>

        </div>
    </div>

<script>
    const supabaseUrl = "https://wazkoegfeuttutfoqfjt.supabase.co";
    const supabaseKey = "sb_publishable_PwMGk7yJAN-1q_a_meHcKQ_CuWSSrgF";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let editandoId = null;

    document.getElementById("imagen").addEventListener("change", () => {
        const file = imagen.files[0];
        if (file) {
            preview.src = URL.createObjectURL(file);
            preview.style.display = "block";
        }
    });

    function abrirModal(id = null) {
        editandoId = id;

        if (id) {
            cargarProducto(id);
            titulo-modal.textContent = "Editar Producto";
        } else {
            limpiarFormulario();
            titulo-modal.textContent = "Nuevo Producto";
        }

        modal.style.display = "flex";
    }

    function cerrarModal() {
        modal.style.display = "none";
    }

    function limpiarFormulario() {
        nombre.value = "";
        precio.value = "";
        descripcion.value = "";
        categoria.value = "navidad";
        estado-normal.checked = true;
        estado-msg.textContent = "";
        preview.style.display = "none";
    }

    function estadoSeleccionado() {
        if (estado-agotado.checked) return "agotado";
        if (estado-liquidacion.checked) return "liquidacion";
        return "normal";
    }

    async function guardarProducto() {
        const data = {
            nombre: nombre.value,
            precio: parseInt(precio.value),
            descripcion: descripcion.value,
            categoria: categoria.value,
            agotado: estado-agotado.checked,
            liquidacion: estado-liquidacion.checked,
        };

        let urlImagen = null;

        if (imagen.files[0]) {
            const archivo = imagen.files[0];
            const nombreArchivo = Date.now() + "-" + archivo.name;

            const { data: imgData, error: imgError } = await supabaseClient
                .storage
                .from("productos")
                .upload(nombreArchivo, archivo);

            if (!imgError) {
                urlImagen = `${supabaseUrl}/storage/v1/object/public/productos/${nombreArchivo}`;
                data.imagen_url = urlImagen;
            }
        }

        if (editandoId) {
            await supabaseClient.from("productos").update(data).eq("id", editandoId);
        } else {
            await supabaseClient.from("productos").insert(data);
        }

        cerrarModal();
        cargarProductos();
    }

    async function cargarProducto(id) {
        const { data } = await supabaseClient.from("productos").select("*").eq("id", id).single();

        nombre.value = data.nombre;
        precio.value = data.precio;
        descripcion.value = data.descripcion;
        categoria.value = data.categoria;

        if (data.agotado) estado-agotado.checked = true;
        else if (data.liquidacion) estado-liquidacion.checked = true;
        else estado-normal.checked = true;

        if (data.imagen_url) {
            preview.src = data.imagen_url;
            preview.style.display = "block";
        }
    }

    async function cargarProductos() {
        const { data } = await supabaseClient.from("productos").select("*").order("id", { ascending: false });

        lista-productos.innerHTML = "";

        data.forEach(p => {
            const div = document.createElement("div");
            div.className = "producto-card";

            let badge = "";
            if (p.agotado) badge = `<div class="badge agotado">AGOTADO</div>`;
            if (p.liquidacion) badge = `<div class="badge liquidacion">LIQUIDACI√ìN</div>`;

            div.innerHTML = `
                <img src="${p.imagen_url}">
                <div style="flex:1">
                    ${badge}
                    <h3>${p.nombre}</h3>
                    <strong>$${p.precio.toLocaleString("es-CL")} CLP</strong>
                    <p>Categor√≠a: ${p.categoria}</p>
                    <p>${p.descripcion}</p>
                    <button onclick="abrirModal(${p.id})" class="btn btn-editar">Editar</button>
                    <button onclick="eliminarProducto(${p.id})" class="btn btn-eliminar">Eliminar</button>
                </div>
            `;

            lista-productos.appendChild(div);
        });
    }

    async function eliminarProducto(id) {
        await supabaseClient.from("productos").delete().eq("id", id);
        cargarProductos();
    }

    cargarProductos();
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

</body>
</html>

