<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Administrador de Productos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --fondo: #ffe9d7;
      --fondo-tarjeta: #fff6ee;
      --primario: #d0382a;
      --primario-oscuro: #a2231c;
      --azul-boton: #2187d9;
      --azul-boton-hover: #1965a3;
      --borde-tarjeta: #f0b26b;
      --texto: #5a2520;
      --gris-suave: #f5f5f7;
      --amarillo-liquidacion: #ffe066;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffe1c0 0, #ffe9d7 35%, #ffe9d7 100%);
      color: var(--texto);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 12px 32px;
    }

    h1 {
      text-align: center;
      color: var(--primario);
      font-size: 32px;
      margin: 10px 0 26px;
      letter-spacing: 0.02em;
    }

    .barra-superior {
      display: flex;
      justify-content: center;
      margin-bottom: 24px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 12px 28px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background-color 0.12s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .btn-primario {
      background-color: var(--azul-boton);
      color: #ffffff;
    }

    .btn-primario:hover {
      background-color: var(--azul-boton-hover);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
    }

    .btn-icono {
      font-size: 18px;
      line-height: 1;
    }

    .grid-productos {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px;
    }

    .tarjeta {
      background: var(--fondo-tarjeta);
      border-radius: 24px;
      padding: 14px 14px 18px;
      border: 2px solid var(--borde-tarjeta);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .estado-badges {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      min-height: 24px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-agotado {
      background: #ff4b4b;
      color: #ffffff;
    }

    .badge-liquidacion {
      background: #ffe066;
      color: #c01717;
      border: 1px solid #f1c34a;
    }

    .imagen-contenedor {
      width: 100%;
      border-radius: 18px;
      overflow: hidden;
      background: #fff0df;
      margin-bottom: 12px;
    }

    .producto-img {
      width: 100%;
      height: 230px; /* cuadrado/apaisado uniforme */
      object-fit: cover;
      display: block;
    }

    .tarjeta-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .tarjeta-titulo {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      color: var(--primario-oscuro);
    }

    .tarjeta-precio {
      font-weight: 700;
      font-size: 16px;
      color: var(--primario);
      margin: 2px 0;
    }

    .tarjeta-categoria {
      font-size: 13px;
      color: #8c4c38;
      margin-bottom: 4px;
    }

    .tarjeta-descripcion {
      font-size: 13px;
      color: #6a3d30;
      margin: 0;
    }

    .texto-estado {
      margin-top: 8px;
      font-size: 13px;
      font-weight: 600;
    }

    .texto-estado-agotado {
      color: #c1272d;
    }

    .texto-estado-liquidacion {
      background: var(--amarillo-liquidacion);
      color: #c01717;
      padding: 6px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
    }

    .tarjeta-footer {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .btn-editar {
      flex: 1;
      background: #ffae34;
      color: #542100;
    }

    .btn-editar:hover {
      background: #f99706;
    }

    .btn-eliminar {
      flex: 1;
      background: #f25b57;
      color: white;
    }

    .btn-eliminar:hover {
      background: #d54542;
    }

    /* Modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .overlay.activo {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: 20px;
      max-width: 480px;
      width: 92%;
      padding: 20px 22px 22px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-titulo {
      font-size: 20px;
      font-weight: 700;
      color: var(--primario-oscuro);
    }

    .modal-cerrar {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: #888;
    }

    .form-grupo {
      margin-bottom: 10px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--texto);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d0c4ba;
      padding: 8px 10px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      background: var(--gris-suave);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--azul-boton);
      box-shadow: 0 0 0 1px rgba(33, 135, 217, 0.15);
      background: #ffffff;
    }

    .form-textarea {
      min-height: 70px;
      resize: vertical;
    }

    .estado-row {
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .estado-opciones {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 4px;
    }

    .estado-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .estado-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--primario);
    }

    .estado-mensaje {
      font-size: 12px;
      margin-top: 4px;
    }

    .estado-mensaje-agotado {
      color: #c1272d;
      font-weight: 600;
    }

    .estado-mensaje-liquidacion {
      background: var(--amarillo-liquidacion);
      color: #c01717;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .preview-img {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-radius: 14px;
      margin-top: 6px;
      border: 1px dashed #e0c4aa;
      background: #fff8f0;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .btn-secundario {
      flex: 1;
      background: #e3ded8;
      color: #54382c;
    }

    .btn-secundario:hover {
      background: #d2cbc3;
    }

    .btn-guardar {
      flex: 1.2;
      background: var(--primario);
      color: white;
    }

    .btn-guardar:hover {
      background: var(--primario-oscuro);
    }

    .mensaje-vacio {
      text-align: center;
      margin-top: 40px;
      font-size: 15px;
      color: #8b5a48;
    }

    @media (max-width: 600px) {
      .tarjeta {
        padding: 12px 12px 16px;
      }
      .producto-img {
        height: 210px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Administrador de Productos</h1>

    <div class="barra-superior">
      <button id="btn-abrir-modal" class="btn btn-primario">
        <span class="btn-icono">‚ûï</span>
        Agregar Producto
      </button>
    </div>

    <div id="lista-productos" class="grid-productos"></div>
    <p id="mensaje-vacio" class="mensaje-vacio" style="display:none;">
      A√∫n no hay productos cargados. Haz clic en <strong>‚ÄúAgregar Producto‚Äù</strong> para crear el primero ü§ó
    </p>
  </div>

  <!-- MODAL -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-titulo" class="modal-titulo">Nuevo producto</h2>
        <button class="modal-cerrar" id="btn-cerrar-modal">&times;</button>
      </div>

      <div class="modal-body">
        <div class="form-grupo">
          <label class="form-label" for="nombre">Nombre</label>
          <input type="text" id="nombre" class="form-input" />
        </div>

        <div class="form-grupo">
          <label class="form-label" for="precio">Precio (solo n√∫mero, sin puntos)</label>
          <input type="number" id="precio" class="form-input" min="0" />
        </div>

        <div class="form-grupo">
          <label class="form-label" for="categoria">Categor√≠a</label>
          <select id="categoria" class="form-select">
            <option value="">Selecciona una categor√≠a</option>
            <option value="navidad">üéÑ Navidad</option>
            <option value="tejido">üßµ Tejido</option>
            <option value="hogar">üè° Hogar</option>
            <option value="ni√±os">üë∂ Ni√±os</option>
            <option value="mujer">üëó Mujer</option>
          </select>
        </div>

        <div class="form-grupo">
          <label class="form-label" for="descripcion">Descripci√≥n</label>
          <textarea id="descripcion" class="form-textarea"></textarea>
        </div>

        <div class="estado-row">
          <span class="form-label">Estado del producto</span>
          <div class="estado-opciones">
            <label class="estado-item">
              <input type="checkbox" id="agotado" />
              <span>Producto agotado</span>
            </label>
            <label class="estado-item">
              <input type="checkbox" id="liquidacion" />
              <span>Producto en liquidaci√≥n</span>
            </label>
          </div>
          <p id="estado-mensaje" class="estado-mensaje"></p>
        </div>

        <div class="form-grupo">
          <label class="form-label" for="imagen">Imagen del producto</label>
          <input type="file" id="imagen" class="form-input" accept="image/*" />
          <img id="preview-img" class="preview-img" alt="" style="display:none;" />
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secundario" id="btn-cancelar">Cancelar</button>
        <button class="btn btn-guardar" id="btn-guardar">Guardar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üîê Reemplaza estos valores por los tuyos
    const SUPABASE_URL = "TU_SUPABASE_URL_AQUI";
    const SUPABASE_ANON_KEY = "TU_SUPABASE_ANON_KEY_AQUI";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Elementos del DOM
    const listaProductosEl = document.getElementById("lista-productos");
    const mensajeVacioEl = document.getElementById("mensaje-vacio");

    const overlay = document.getElementById("overlay");
    const btnAbrirModal = document.getElementById("btn-abrir-modal");
    const btnCerrarModal = document.getElementById("btn-cerrar-modal");
    const btnCancelar = document.getElementById("btn-cancelar");
    const btnGuardar = document.getElementById("btn-guardar");
    const modalTitulo = document.getElementById("modal-titulo");

    const inputNombre = document.getElementById("nombre");
    const inputPrecio = document.getElementById("precio");
    const inputCategoria = document.getElementById("categoria");
    const inputDescripcion = document.getElementById("descripcion");
    const chkAgotado = document.getElementById("agotado");
    const chkLiquidacion = document.getElementById("liquidacion");
    const estadoMensaje = document.getElementById("estado-mensaje");
    const inputImagen = document.getElementById("imagen");
    const previewImg = document.getElementById("preview-img");

    let productoEditando = null;
    let urlImagenActual = null;

    // ---------- ESTADO: MENSAJES EN EL FORMULARIO ----------
    function actualizarMensajeEstado() {
      estadoMensaje.textContent = "";
      estadoMensaje.className = "estado-mensaje"; // reset

      if (chkAgotado.checked && chkLiquidacion.checked) {
        estadoMensaje.textContent =
          "Marcaste AGOTADO y LIQUIDACI√ìN al mismo tiempo. Revisa si esto tiene sentido üòä";
      } else if (chkAgotado.checked) {
        estadoMensaje.textContent = "Este producto est√° agotado üò¢";
        estadoMensaje.classList.add("estado-mensaje-agotado");
      } else if (chkLiquidacion.checked) {
        estadoMensaje.textContent = "Producto en liquidaci√≥n üî•";
        estadoMensaje.classList.add("estado-mensaje-liquidacion");
      }
    }

    chkAgotado.addEventListener("change", actualizarMensajeEstado);
    chkLiquidacion.addEventListener("change", actualizarMensajeEstado);

    // ---------- MODAL ----------
    function abrirModal(nuevo = true, producto = null) {
      overlay.classList.add("activo");
      if (nuevo) {
        modalTitulo.textContent = "Nuevo producto";
        productoEditando = null;
        urlImagenActual = null;
        inputNombre.value = "";
        inputPrecio.value = "";
        inputCategoria.value = "";
        inputDescripcion.value = "";
        chkAgotado.checked = false;
        chkLiquidacion.checked = false;
        actualizarMensajeEstado();
        inputImagen.value = "";
        previewImg.style.display = "none";
        previewImg.src = "";
      } else if (producto) {
        modalTitulo.textContent = "Editar producto";
        productoEditando = producto;
        urlImagenActual = producto.imagen_url || null;

        inputNombre.value = producto.nombre || "";
        inputPrecio.value = producto.precio ?? "";
        inputCategoria.value = producto.categoria || "";
        inputDescripcion.value = producto.descripcion || "";
        chkAgotado.checked = !!producto.agotado;
        chkLiquidacion.checked = !!producto.liquidacion;
        actualizarMensajeEstado();

        inputImagen.value = "";
        if (producto.imagen_url) {
          previewImg.src = producto.imagen_url;
          previewImg.style.display = "block";
        } else {
          previewImg.style.display = "none";
        }
      }
    }

    function cerrarModal() {
      overlay.classList.remove("activo");
    }

    btnAbrirModal.addEventListener("click", () => abrirModal(true));
    btnCerrarModal.addEventListener("click", cerrarModal);
    btnCancelar.addEventListener("click", cerrarModal);

    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) cerrarModal();
    });

    // Preview de imagen
    inputImagen.addEventListener("change", () => {
      const file = inputImagen.files?.[0];
      if (!file) {
        previewImg.style.display = "none";
        previewImg.src = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewImg.style.display = "block";
      };
      reader.readAsDataURL(file);
    });

    // ---------- SUPABASE: CARGAR PRODUCTOS ----------
    async function cargarProductos() {
      try {
        const { data, error } = await supabase
          .from("productos")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error al cargar productos:", error);
          alert("Ocurri√≥ un problema al cargar los productos.");
          return;
        }

        renderProductos(data || []);
      } catch (err) {
        console.error("Error inesperado al cargar productos:", err);
        alert("Ocurri√≥ un error inesperado al cargar los productos.");
      }
    }

    function formatearPrecioCLP(valor) {
      if (valor == null || valor === "") return "";
      const numero = Number(valor);
      if (Number.isNaN(numero)) return "";
      return numero.toLocaleString("es-CL");
    }

    function renderProductos(productos) {
      listaProductosEl.innerHTML = "";

      if (!productos.length) {
        mensajeVacioEl.style.display = "block";
        return;
      } else {
        mensajeVacioEl.style.display = "none";
      }

      for (const p of productos) {
        const div = document.createElement("div");
        div.className = "tarjeta";

        const imagenUrl =
          p.imagen_url ||
          "https://via.placeholder.com/600x600.png?text=Sin+imagen";

        div.innerHTML = `
          <div class="estado-badges">
            ${
              p.agotado
                ? `<span class="badge badge-agotado">AGOTADO</span>`
                : ""
            }
            ${
              p.liquidacion
                ? `<span class="badge badge-liquidacion">LIQUIDACI√ìN</span>`
                : ""
            }
          </div>

          <div class="imagen-contenedor">
            <img class="producto-img" src="${imagenUrl}" alt="${p.nombre || ""}" />
          </div>

          <div class="tarjeta-body">
            <h3 class="tarjeta-titulo">${p.nombre || ""}</h3>
            <p class="tarjeta-precio">
              ${p.precio != null ? `$${formatearPrecioCLP(p.precio)} CLP` : ""}
            </p>
            <p class="tarjeta-categoria">
              ${
                p.categoria
                  ? `Categor√≠a: ${p.categoria.toString().toLowerCase()}`
                  : ""
              }
            </p>
            <p class="tarjeta-descripcion">
              ${p.descripcion ? p.descripcion : ""}
            </p>
            ${
              p.agotado
                ? `<p class="texto-estado texto-estado-agotado">Este producto est√° agotado üò¢</p>`
                : ""
            }
            ${
              !p.agotado && p.liquidacion
                ? `<p class="texto-estado texto-estado-liquidacion">Producto en liquidaci√≥n üî•</p>`
                : ""
            }
          </div>

          <div class="tarjeta-footer">
            <button class="btn btn-editar">Editar</button>
            <button class="btn btn-eliminar">Eliminar</button>
          </div>
        `;

        const btnEditar = div.querySelector(".btn-editar");
        const btnEliminar = div.querySelector(".btn-eliminar");

        btnEditar.addEventListener("click", () => abrirModal(false, p));
        btnEliminar.addEventListener("click", () => eliminarProducto(p));

        listaProductosEl.appendChild(div);
      }
    }

    // ---------- SUPABASE: SUBIR IMAGEN ----------
    async function subirImagenSiEsNecesario() {
      const file = inputImagen.files?.[0];
      if (!file) {
        // No se cambi√≥ la imagen
        return urlImagenActual;
      }

      const extension = file.name.split(".").pop();
      const nombreArchivo = `${Date.now()}-${Math.random()
        .toString(36)
        .slice(2)}.${extension}`;

      const { data, error } = await supabase.storage
        .from("productos")
        .upload(nombreArchivo, file, {
          cacheControl: "3600",
          upsert: false,
        });

      if (error) {
        console.error("Error al subir imagen:", error);
        alert("No se pudo subir la imagen. Revisa los permisos de Storage.");
        return null;
      }

      const { data: publicUrlData } = supabase.storage
        .from("productos")
        .getPublicUrl(data.path);

      return publicUrlData.publicUrl;
    }

    // ---------- GUARDAR (INSERT / UPDATE) ----------
    btnGuardar.addEventListener("click", async () => {
      const nombre = inputNombre.value.trim();
      const precio = inputPrecio.value.trim();
      const categoria = inputCategoria.value;
      const descripcion = inputDescripcion.value.trim();
      const agotado = chkAgotado.checked;
      const liquidacion = chkLiquidacion.checked;

      if (!nombre) {
        alert("El nombre es obligatorio.");
        return;
      }

      if (!precio) {
        alert("El precio es obligatorio.");
        return;
      }

      const precioNum = Number(precio);
      if (Number.isNaN(precioNum) || precioNum < 0) {
        alert("El precio debe ser un n√∫mero v√°lido.");
        return;
      }

      let imagenUrl = await subirImagenSiEsNecesario();
      if (imagenUrl === null && inputImagen.files?.[0]) {
        // Hubo error subiendo la imagen
        return;
      }
      if (!imagenUrl && urlImagenActual) {
        imagenUrl = urlImagenActual;
      }

      const payload = {
        nombre,
        precio: precioNum,
        categoria,
        descripcion,
        agotado,
        liquidacion,
        imagen_url: imagenUrl || null,
      };

      try {
        if (!productoEditando) {
          // INSERT
          const { error } = await supabase.from("productos").insert([payload]);
          if (error) {
            console.error("Error al crear producto:", error);
            alert("No se pudo crear el producto.");
            return;
          }
        } else {
          // UPDATE
          const { error } = await supabase
            .from("productos")
            .update(payload)
            .eq("id", productoEditando.id);

          if (error) {
            console.error("Error al actualizar producto:", error);
            alert("No se pudo actualizar el producto.");
            return;
          }
        }

        cerrarModal();
        await cargarProductos();
      } catch (err) {
        console.error("Error inesperado al guardar:", err);
        alert("Ocurri√≥ un error inesperado al guardar el producto.");
      }
    });

    // ---------- ELIMINAR ----------
    async function eliminarProducto(producto) {
      const confirmar = window.confirm(
        `¬øSeguro que deseas eliminar "${producto.nombre}"?`
      );
      if (!confirmar) return;

      try {
        const { error } = await supabase
          .from("productos")
          .delete()
          .eq("id", producto.id);

        if (error) {
          console.error("Error al eliminar producto:", error);
          alert("No se pudo eliminar el producto.");
          return;
        }

        cargarProductos();
      } catch (err) {
        console.error("Error inesperado al eliminar:", err);
        alert("Ocurri√≥ un error al eliminar el producto.");
      }
    }

    // ---------- INICIO ----------
    cargarProductos();
  </script>
</body>
</html>
