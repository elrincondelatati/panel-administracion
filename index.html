<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administrador de Productos</title>

    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: "Poppins", sans-serif;
            background: #fbeee6;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 90%;
            max-width: 1100px;
            margin: auto;
        }

        .titulo {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            color: #922b21;
            padding: 20px 0;
        }

        .boton-agregar {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        button {
            cursor: pointer;
        }

        .boton {
            background-color: #3498db;
            color: white;
            padding: 12px 22px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
        }

        /* TARJETAS */
        .lista-productos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 25px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .card img {
            width: 100%;
            height: 260px;
            object-fit: cover;
            border-radius: 14px;
        }

        .nombre {
            font-size: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        .precio {
            color: #c0392b;
            font-size: 22px;
            font-weight: bold;
        }

        .categoria-tag {
            background: #f7dc6f;
            padding: 5px 12px;
            border-radius: 10px;
            display: inline-block;
            font-weight: bold;
        }

        /* ETIQUETAS AGOTADO / LIQUIDACI√ìN */
        .etiqueta-agotado {
            position: absolute;
            top: 15px;
            left: -10px;
            background: red;
            color: white;
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
            transform: rotate(-15deg);
            border-radius: 8px;
        }

        .etiqueta-liquidacion {
            position: absolute;
            top: 15px;
            left: -10px;
            background: yellow;
            color: red;
            padding: 12px 20px;
            font-size: 18px;
            font-weight: bold;
            transform: rotate(-15deg);
            border-radius: 8px;
        }

        /* MODAL */
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.45);
            justify-content: center;
            align-items: center;
        }

        #modal-contenido {
            background: white;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            border-radius: 14px;
        }

        .input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-family: inherit;
        }

        .checkbox-area {
            margin-top: 10px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .msg-opcion {
            font-weight: bold;
            display: none;
        }

        .msg-agotado {
            color: #b30000;
        }

        .msg-liquidacion {
            background: yellow;
            color: red;
            padding: 5px 10px;
            border-radius: 6px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 class="titulo">Administrador de Productos</h1>

        <div class="boton-agregar">
            <button class="boton" onclick="abrirModal()">‚ûï Agregar Producto</button>
        </div>

        <div id="lista-productos" class="lista-productos"></div>
    </div>

    <!-- MODAL -->
    <div id="modal">
        <div id="modal-contenido">

            <h2 id="titulo-modal">Nuevo Producto</h2>

            <label>Nombre:</label>
            <input type="text" id="nombre" class="input">

            <label>Precio:</label>
            <input type="number" id="precio" class="input">

            <label>Descripci√≥n:</label>
            <textarea id="descripcion" class="input"></textarea>

            <label>Categor√≠a:</label>
            <select id="categoria" class="input">
                <option value="navidad">üéÑ Navidad</option>
                <option value="tejido">üß∂ Tejido</option>
                <option value="hogar">üè° Hogar</option>
                <option value="ni√±os">üë∂ Ni√±os</option>
                <option value="mujer">üëó Mujer</option>
            </select>

            <label>Opciones del producto:</label>
            <div class="checkbox-area">

                <div>
                    <input type="checkbox" id="agotado">
                    <span id="msg-agotado" class="msg-opcion msg-agotado">Producto agotado ‚ùå</span>
                </div>

                <div>
                    <input type="checkbox" id="liquidacion">
                    <span id="msg-liquidacion" class="msg-opcion msg-liquidacion">Producto en liquidaci√≥n üî•</span>
                </div>

            </div>

            <label>Imagen:</label>
            <input type="file" id="imagen" accept="image/*" onchange="mostrarPreview()">
            <img id="preview" style="width:100%; border-radius:10px; margin-top:10px; display:none;">

            <button class="boton" onclick="guardarProducto()">Guardar</button>
            <button class="boton" style="background:#b03a2e;" onclick="cerrarModal()">Cerrar</button>
        </div>
    </div>

    <!-- SUPABASE JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const supabaseUrl = "https://wazkoegfeuttutfoqfjt.supabase.co";
        const supabaseKey = "TU_KEY_AQUI";
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let editandoID = null;

        // MOSTRAR PREVIEW DE IMAGEN
        function mostrarPreview() {
            const file = document.getElementById("imagen").files[0];
            const preview = document.getElementById("preview");

            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = "block";
            }
        }

        // ABRIR MODAL
        function abrirModal() {
            editandoID = null;
            document.getElementById("titulo-modal").innerText = "Nuevo Producto";
            document.getElementById("modal").style.display = "flex";
            limpiarFormulario();
        }

        // CERRAR MODAL
        function cerrarModal() {
            document.getElementById("modal").style.display = "none";
        }

        // LIMPIAR CAMPOS
        function limpiarFormulario() {
            document.getElementById("nombre").value = "";
            document.getElementById("precio").value = "";
            document.getElementById("descripcion").value = "";
            document.getElementById("categoria").value = "navidad";
            document.getElementById("agotado").checked = false;
            document.getElementById("liquidacion").checked = false;

            document.getElementById("msg-agotado").style.display = "none";
            document.getElementById("msg-liquidacion").style.display = "none";

            document.getElementById("imagen").value = "";
            document.getElementById("preview").style.display = "none";
        }

        // GUARDAR PRODUCTO
        async function guardarProducto() {

            const nombre = document.getElementById("nombre").value;
            const precio = document.getElementById("precio").value;
            const descripcion = document.getElementById("descripcion").value;
            const categoria = document.getElementById("categoria").value;
            const agotado = document.getElementById("agotado").checked;
            const liquidacion = document.getElementById("liquidacion").checked;

            let imagen_url = null;

            const imagenFile = document.getElementById("imagen").files[0];

            if (imagenFile) {
                const fileName = Date.now() + "_" + imagenFile.name;

                let { data, error } = await supabase.storage
                    .from("productos")
                    .upload(fileName, imagenFile);

                if (error) {
                    alert("Error al subir imagen");
                    return;
                }

                imagen_url = `https://wazkoegfeuttutfoqfjt.supabase.co/storage/v1/object/public/productos/${fileName}`;
            }

            const productoData = {
                nombre,
                precio,
                descripcion,
                categoria,
                agotado,
                liquidacion,
                imagen_url
            };

            let resultado;

            if (editandoID) {
                resultado = await supabase
                    .from("productos")
                    .update(productoData)
                    .eq("id", editandoID);
            } else {
                resultado = await supabase
                    .from("productos")
                    .insert([productoData]);
            }

            if (resultado.error) {
                alert("Error al guardar producto");
                return;
            }

            cerrarModal();
            cargarProductos();
        }

        // MOSTRAR PRODUCTOS
        async function cargarProductos() {
            const { data, error } = await supabase
                .from("productos")
                .select("*")
                .order("id", { ascending: false });

            const cont = document.getElementById("lista-productos");
            cont.innerHTML = "";

            data.forEach(prod => {

                let etiqueta = "";
                if (prod.agotado) {
                    etiqueta = `<div class="etiqueta-agotado">PRODUCTO AGOTADO</div>`;
                } else if (prod.liquidacion) {
                    etiqueta = `<div class="etiqueta-liquidacion">EN LIQUIDACI√ìN</div>`;
                }

                cont.innerHTML += `
                    <div class="card">
                        ${etiqueta}
                        <img src="${prod.imagen_url || ""}">
                        <div class="nombre">${prod.nombre}</div>
                        <div class="precio">$${prod.precio} CLP</div>
                        <div class="categoria-tag">${prod.categoria}</div>
                        <button onclick="editarProducto(${prod.id})" class="boton" style="margin-top:10px;">Editar</button>
                        <button onclick="eliminarProducto(${prod.id})" class="boton" style="margin-top:10px; background:#c0392b;">Eliminar</button>
                    </div>
                `;
            });
        }

        // EDITAR PRODUCTO
        async function editarProducto(id) {
            editandoID = id;

            const { data } = await supabase
                .from("productos")
                .select("*")
                .eq("id", id)
                .single();

            document.getElementById("nombre").value = data.nombre;
            document.getElementById("precio").value = data.precio;
            document.getElementById("descripcion").value = data.descripcion;
            document.getElementById("categoria").value = data.categoria;

            document.getElementById("agotado").checked = data.agotado;
            document.getElementById("liquidacion").checked = data.liquidacion;

            document.getElementById("msg-agotado").style.display = data.agotado ? "inline-block" : "none";
            document.getElementById("msg-liquidacion").style.display = data.liquidacion ? "inline-block" : "none";

            if (data.imagen_url) {
                const preview = document.getElementById("preview");
                preview.src = data.imagen_url;
                preview.style.display = "block";
            }

            document.getElementById("modal").style.display = "flex";
        }

        // ELIMINAR
        async function eliminarProducto(id) {
            if (!confirm("¬øEliminar producto?")) return;

            await supabase.from("productos").delete().eq("id", id);
            cargarProductos();
        }

        cargarProductos();
    </script>

</body>

</html>
