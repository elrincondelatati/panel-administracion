<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Administrador - Catálogo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f6f6f6;
            padding: 20px;
        }

        h2 { margin-top: 40px; }

        .producto {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
        }

        .producto img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }

        .btn {
            background: #007bff;
            padding: 6px 12px;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            margin-right: 6px;
        }

        .btn-danger { background: red; }
        .btn-warning { background: orange; }
    </style>
</head>

<body>

<h1>Administrador del Catálogo</h1>

<!-- FORMULARIO -->
<h2>Agregar producto</h2>

<label>Nombre:</label><br>
<input id="nombre" type="text"><br><br>

<label>Precio:</label><br>
<input id="precio" type="number"><br><br>

<label>Descripción:</label><br>
<textarea id="descripcion"></textarea><br><br>

<label>Categoría:</label><br>
<input id="categoria" type="text"><br><br>

<label>Imagen:</label><br>
<input id="imagen" type="file"><br><br>

<button class="btn" onclick="guardarProducto()">Guardar producto</button>

<hr>

<h2>Productos</h2>
<div id="lista-productos"></div>

<!-- SUPABASE SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.min.js"></script>

<script type="module">
    /* CONFIGURACIÓN SUPABASE */
    const SUPABASE_URL = "https://wazkoegfeuttutfoqfjt.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_PwMGk7yJAN-1q_a_meHcKQ_CuWSSrgF";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* CARGAR PRODUCTOS */
    async function cargarProductos() {
        const { data: productos, error } = await supabaseClient
            .from("productos")
            .select("*")
            .order("id", { ascending: false });

        if (error) {
            alert("Error cargando productos");
            return;
        }

        let html = "";

        productos.forEach(p => {
            html += `
                <div class="producto">
                    <img src="${p.imagen_url}">
                    <div>
                        <b>${p.nombre}</b><br>
                        $${p.precio}<br>
                        ${p.descripcion}<br>
                        Categoría: ${p.categoria}<br>
                        Estado: ${p.agotado ? "AGOTADO" : "Disponible"}<br><br>

                        <button class="btn-warning" onclick="toggleAgotado(${p.id}, ${p.agotado})">
                            ${p.agotado ? "Marcar disponible" : "Marcar agotado"}
                        </button>

                        <button class="btn-danger" onclick="eliminarProducto(${p.id})">
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
        });

        document.getElementById("lista-productos").innerHTML = html;
    }

    cargarProductos();

    /* GUARDAR NUEVO PRODUCTO */
    async function guardarProducto() {
        const nombre = document.getElementById("nombre").value;
        const precio = document.getElementById("precio").value;
        const descripcion = document.getElementById("descripcion").value;
        const categoria = document.getElementById("categoria").value;
        const archivo = document.getElementById("imagen").files[0];

        if (!archivo) return alert("Selecciona una imagen");

        // Subir imagen
        const nombreArchivo = Date.now() + "-" + archivo.name;

        const { data: img, error: imgError } = await supabaseClient
            .storage
            .from("productos")
            .upload(nombreArchivo, archivo);

        if (imgError) {
            alert("Error subiendo imagen");
            return;
        }

        // Obtener URL pública
        const urlPublica = `${SUPABASE_URL}/storage/v1/object/public/productos/${nombreArchivo}`;

        // Insertar en BD
        const { error } = await supabaseClient
            .from("productos")
            .insert({
                nombre,
                precio,
                descripcion,
                categoria,
                imagen_url: urlPublica,
                agotado: false
            });

        if (error) {
            alert("Error guardando producto");
            return;
        }

        alert("Producto guardado");
        cargarProductos();
    }

    /* ELIMINAR PRODUCTO */
    async function eliminarProducto(id) {
        if (!confirm("¿Eliminar producto?")) return;

        await supabaseClient.from("productos").delete().eq("id", id);
        cargarProductos();
    }

    /* MARCAR AGOTADO / DISPONIBLE */
    async function toggleAgotado(id, estadoActual) {
        await supabaseClient
            .from("productos")
            .update({ agotado: !estadoActual })
            .eq("id", id);

        cargarProductos();
    }

</script>

</body>
</html>
